<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://unpkg.com/monaco-editor@latest/min/vs/editor/editor.main.css">
</head>

<style>
    body {
        margin: 0;

        background: #333333;
        color: #E1E1E1;
        font-family: "Courier New";
        height: 100vh;
    }

    .col {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .row {
        height: 100%;
        display: flex;
        flex-direction: row;
    }

    #editor {
        width: 100%;
        height: 100%;
    }

    #stdout {
        width: 50vw;
        height: 30%;
        background: #252526;
        overflow: auto;
        word-wrap: normal;
        font-size: 14px;
        margin: 0;
        padding: 1em;
    }

    #canvas {
        background: black;
        width: 50vw;
        aspect-ratio: 320 / 240;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
    }

    #debugger {
        background: green;
        width: 100%;
        height: 100%;
    }
</style>

<body>
<!-- Monaco editor JS files need to be included in the <body> tag. Who knows why... -->
<script src="ulang.js"></script>
<script>var require = {paths: {'vs': 'https://unpkg.com/monaco-editor@latest/min/vs'}};</script>
<script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
<script src="https://unpkg.com/monaco-editor@latest/min/vs/editor/editor.main.nls.js"></script>
<script src="https://unpkg.com/monaco-editor@latest/min/vs/editor/editor.main.js"></script>

<div class="row">
    <div class="col">
        <div id="editor"></div>
        <pre id="stdout"></pre>
    </div>
    <div class="col">
        <canvas id="canvas" width="320" height="240"></canvas>
        <div id="debugger">
            <button id="debug-run">Run</button>
            <button id="debug-stop">Stop</button>
            <button id="debug-step">Step</button>
        </div>
    </div>
</div>

<script>
    ulang().then((ulang) => {
        // Redirect stdout to print to the stdout element.
        (function () {
            let stdout = document.getElementById("stdout");
            let oldLog = console.log;
            console.log = (str) => {
                stdout.innerHTML += str + "<br>";
                oldLog(str);
            }
        }());

        let compile = function (source) {
            let result = {
                error: ulang.newError(),
                file: ulang.newFile("source", source),
                program: ulang.newProgram(),
                free: function () {
                    this.program.free();
                    this.file.free();
                    this.error.free();
                }
            }
            ulang.compile(result.file, result.program, result.error);
            return result;
        };

        let editor = function () {
            defineUlangLanguage();

            let editor = monaco.editor.create(document.getElementById("editor"), {
                automaticLayout: true,
                theme: "vs-dark",
                language: "ulang"
            });
            let deltaDecorations = [];

            editor.onDidChangeModelContent((e) => {
                stdout.innerHTML = "";
                let result = compile(editor.getValue(0));
                if (result.error.isSet()) {
                    result.error.print();
                    let startLineNumber = result.error.span().startLine();
                    let startLine = result.file.lines()[startLineNumber]
                    let endLineNumber = result.error.span().endLine();
                    let endLine = result.file.lines()[endLineNumber];

                    let spanStart = result.error.span().data().data();
                    let spanEnd = spanStart + result.error.span().data().length();

                    let startCol = spanStart - startLine.data().data();
                    let endCol = spanEnd - endLine.data().data();
                    deltaDecorations = editor.deltaDecorations(deltaDecorations, [{range: new monaco.Range(startLineNumber, startCol, endLineNumber, endCol), options: {inlineClassName: '.squiggly-error'}}]);
                } else {
                    deltaDecorations = editor.deltaDecorations(deltaDecorations, []);
                }
                result.free();
                ulang.printMemory();
            });

            editor.setValue(exampleFire);

            this.getContent = () => editor.getValue(0);

            return this;
        }();

        let debug = function (editor) {
            const STATE_RUNNING = 0;
            const STATE_PAUSED = 1;
            const STATE_STOPPED = 2;

            let canvas = document.getElementById("canvas");
            let run = document.getElementById("debug-run");
            let stop = document.getElementById("debug-stop");
            let step = document.getElementById("debug-step");
            let compilerResult = null;
            let vm = null;
            let vmStart = 0;
            let executedInstructions = 0;
            let state = STATE_STOPPED;
            let vsyncHit = false;

            let syscallHandler = (syscall, vmPtr) => {
                let vm = ulang.nativeToJsVm(vmPtr);
                switch (syscall) {
                    case 0:
                        return 0;
                    case 1:
                        let buffer = vm.popUint();
                        ulang.argbToRgba(vm.memoryPtr() + buffer, 320 * 240);
                        let frame = new Uint8ClampedArray(ulang.HEAPU8.buffer, vm.memoryPtr() + buffer, 320 * 240 * 4);
                        let imageData = new ImageData(frame, 320, 240);
                        canvas.getContext("2d").putImageData(imageData, 0, 0);
                        vsyncHit = true;
                        return 0;
                    case 2: {
                        let numArgs = vm.popUint();
                        let str = "";
                        for (let i = 0; i < numArgs; i++) {
                            let argType = vm.popUint(vm);
                            switch (argType) {
                                case 0:
                                    str += vm.popInt();
                                    break;
                                case 1:
                                    str += "0x" + vm.popInt().toString(16);
                                    break;
                                case 2:
                                    str += vm.popFloat();
                                    break;
                                case 3:
                                    let strAddr = vm.popUint();
                                    str += ulang.UTF8ArrayToString(ulang.HEAPU8, vm.memoryPtr() + strAddr);
                                    break;
                                default:
                                    break;
                            }
                        }
                        console.log(str);
                        return -1;
                    }
                }
            }
            let syscallHandlerPtr = ulang.addFunction(syscallHandler, "iii");

            run.addEventListener("click", () => {
                if (compilerResult) {
                    compilerResult.free();
                    compilerResult = null;
                }
                if (vm) {
                    vm.free();
                    vm = null;
                }

                compilerResult = compile(editor.getContent());
                if (compilerResult.error.isSet()) {
                    alert("Can't run program with error.");
                    compilerResult.free();
                    return;
                }
                vm = ulang.newVm(compilerResult.program);
                vm.setSyscall(0, syscallHandlerPtr);
                vm.setSyscall(1, syscallHandlerPtr);
                vm.setSyscall(2, syscallHandlerPtr);
                vmStart = performance.now();
                executedInstructions = 0;
                state = STATE_RUNNING;
                console.log("Starting vm.");
                requestAnimationFrame(frame);
            });
            stop.addEventListener("click", () => {
                if (state != STATE_RUNNING) return;
                state = STATE_STOPPED;
                printVmTime();
                vm.print();
            });

            let printVmTime = () => {
                let vmTime = (performance.now() - vmStart) / 1000;
                console.log("VM took " + vmTime + " secs");
                console.log("Executed " + executedInstructions + " instructions, " + ((executedInstructions / vmTime) | 0) + " ins/s");
            }

            let frame = () => {
                if (state == STATE_RUNNING) {
                    let frameStart = performance.now();
                    const instsPerStep = 20000;
                    while (true) {
                        executedInstructions += instsPerStep;
                        if (!vm.stepN(instsPerStep)) {
                            if (vsyncHit) {
                                vsyncHit = false;
                                requestAnimationFrame(frame);
                                return;
                            }
                            state = STATE_STOPPED;
                            printVmTime();
                            vm.print();
                            return;
                        }
                        let frameTime = performance.now() - frameStart;
                        if (frameTime > 16) {
                            requestAnimationFrame(frame);
                            return;
                        }
                    }
                }
            }

            return this;
        }(editor);
    });

    let defineUlangLanguage = () => {
        monaco.languages.register({id: 'ulang'});
        monaco.languages.setMonarchTokensProvider('ulang', {
            defaultToken: 'invalid',
            keywords: [
                "halt", "brk", "add", "sub", "mul", "div", "divu", "rem", "remu", "addf", "subf", "mulf", "divf", "cosf", "sinf", "atan2", "sqrtf", "powf", "rand", "i2f", "f2i",
                "not", "and", "or", "xor", "shl", "shr", "shru",
                "cmp", "cmpu", "cmpf",
                "jmp", "je", "jne", "jl", "jg", "jle", "jge",
                "mov",
                "ld", "sto", "ldb", "stob", "lds", "stos",
                "push", "stackalloc", "pop",
                "call", "ret", "retn",
                "syscall",
                "reserve", "byte", "short", "int", "float"
            ],
            operators: ["~", "+", "-", "|", "&", "^", "/", "*", "%"],
            registers: ["r1", "r2", "r3", "r4", "r5", "r6", "r7", "r8", "r9", "r10", "r11", "r12", "r13", "r14", "pc", "sp"],
            escapes: /\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,
            tokenizer: {
                root: [
                    // identifiers and keywords
                    [/[a-z_$][\w$]*/, {
                        cases: {
                            '@keywords': 'keyword',
                            "@registers": "attribute.name",
                            '@default': 'annotation'
                        }
                    }],
                    {include: '@whitespace'},
                    [/[=><!~?:&|+\-*\/\^%]+/, {
                        cases: {
                            '@operators': 'operator',
                            '@default': ''
                        }
                    }],
                    [/\d*\.\d+([eE][\-+]?\d+)?/, 'number.float'],
                    [/0[xX][0-9a-fA-F]+/, 'number.hex'],
                    [/\d+/, 'number'],
                    [/[;,.]/, 'delimiter'],
                    [/"([^"\\]|\\.)*$/, 'string.invalid'],  // non-teminated string
                    [/"/, {token: 'string.quote', bracket: '@open', next: '@string'}],
                ],
                string: [
                    [/[^\\"]+/, 'string'],
                    [/@escapes/, 'string.escape'],
                    [/\\./, 'string.escape.invalid'],
                    [/"/, {token: 'string.quote', bracket: '@close', next: '@pop'}]
                ],
                whitespace: [
                    [/[ \t\r\n]+/, 'white'],
                    [/#.*$/, 'comment'],
                ],
            },
        });
    }

    let exampleFire = `buffer: reserve int x 320 * 240 * 4
fire: reserve byte x 320 * 240
palette: int 0xff070707, 0xff1F0707, 0xff2F0F07, 0xff470F07, 0xff571707, 0xff671F07, 0xff771F07, 0xff8F2707, 0xff9F2F07, 0xffAF3F07, 0xffBF4707, 0xffC74707, 0xffDF4F07, 0xffDF5707, 0xffDF5707, 0xffD75F07, 0xffD75F07, 0xffD7670F, 0xffCF6F0F, 0xffCF770F, 0xffCF7F0F, 0xffCF8717, 0xffC78717, 0xffC78F17, 0xffC7971F, 0xffBF9F1F,0xffBF9F1F, 0xffBFA727, 0xffBFA727, 0xffBFAF2F, 0xffB7AF2F, 0xffB7B72F, 0xffB7B737, 0xffCFCF6F, 0xffDFDF9F, 0xffEFEFC7, 0xffFFFFFF

   # clear buffer
   mov buffer, r1
   mov 0, r2
   mov 0xff000000, r3
clear_buffer_loop:
   sto r3, r1, r2
   add r2, 4, r2
   cmp r2, 320 * 240 * 4, r4
   jl r4, clear_buffer_loop

   # clear fire
   mov fire, r1
   mov 0, r2
   mov 0, r3
clear_fire_loop:
   sto r3, r1, r2
   add r2, 1, r2
   cmp r2, 320 * 240, r4
   jl r4, clear_fire_loop

   # set bottom fire row
   mov 320 * 239, r2
   mov 36, r3
set_bottom_fire_loop:
   sto r3, r1, r2
   add r2, 1, r2
   cmp r2, 320 * 240, r4
   jl r4, set_bottom_fire_loop

main_loop:

   # update fire
   mov fire, r1
   add r1, 320 * 240, r2
   add r1, 320, r1

   update_fire_loop:
      rand r6
      mulf r6, 3, r6
      f2i r6, r6
      mov r6, r7
      and r6, 1, r6

      ldb r1, 0, r4
      sub r4, r6, r4
      cmp r4, 0, r5
      jge r5, set_fire
      mov 0, r4
   set_fire:
      mov r1, r3
      sub r3, 320, r3 # to
      sub r3, r7, r3
      add r3, 1, r3
      stob r4, r3, 0

      add r1, 1, r1
      cmp r1, r2, r5
      jl r5, update_fire_loop

   # draw fire
   mov fire, r1
   add r1, 320 * 240, r2
   mov buffer, r3
   mov palette, r4

   draw_fire_loop:
      # load fire color
      ldb r1, 0, r5
      mul r5, 4, r5
      add r5, palette, r5
      ld r5, 0, r5

      # store in buffer
      sto r5, r3, 0

      # advance to next pixel
      add r1, 1, r1
      add r3, 4, r3
      cmp r1, r2, r5
      jl r5, draw_fire_loop


   # update buffer
   push buffer
   syscall 0x1

   push 1
   jmp main_loop
`;

    let exampleFib = `   push 30
   call fib
   halt

fib:
   # n == 0? return 0
   ld sp, 4, r1
   cmp r1, 0, r2
   jne r2, not_zero
   mov 0, r14
   retn 1

not_zero:
   # n == 1 || n == 2? return 1
   cmp r1, 2, r2
   jg r2, not_one_two
   mov 1, r14
   retn 1

not_one_two:
   # fib(n-1) + fib(n-2)
   sub r1, 1, r1
   push r1
   call fib
   push r14

   ld sp, 8, r1
   sub r1, 2, r1
   push r1
   call fib
   pop r13
   add r14, r13, r14
   retn 1
`;

    let examplePrint = `msg: byte "Hello world! "

push 123
push 0
push 0xff00ff
push 1
push 123.456
push 2
push msg
push 3
push 4
syscall 0x2
halt
`;
</script>
</body>

</html>
